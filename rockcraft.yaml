# Copyright 2023 Canonical Ltd.
# See LICENSE file for licensing details.
name: zookeeper
summary: Apache Zookeeper in a ROCK.
description: |
  ZooKeeper is a centralized service for maintaining configuration
  information, naming, providing distributed synchronization, and
  providing group services.
version: "3.6.4"
base: ubuntu:22.04
license: Apache-2.0


platforms:
  amd64:  # Make sure this value matches your computer's architecture

env:
  - JAVA_HOME: /usr/lib/jvm/java-8-openjdk-amd64/jre
  - ZOO_LOG_DIR: /opt/zookeeper/logs

parts:
  zookeeper:
    plugin: nil
    stage-packages:
      - openjdk-8-jre-headless
    build-environment:
      - JAVA_HOME: /usr/lib/jvm/java-8-openjdk-amd64/
    stage-snaps:
      - zookeeper/latest/edge

    override-build: |
      mkdir -p $CRAFT_PART_INSTALL/opt/zookeeper/logs
      ln -s /usr/lib/jvm/java-8-openjdk-amd64/bin/java \
        $CRAFT_PART_INSTALL/usr/bin/java
      ln -s /usr/lib/jvm/java-8-openjdk-amd64/bin/keytool \
        $CRAFT_PART_INSTALL/usr/bin/keytool
    override-prime: |
      craftctl default
      rm -vf usr/lib/jvm/java-8-openjdk-amd64/jre/lib/security/cacerts
  non-root-user:
    plugin: nil
    after: [zookeeper]
    overlay-script: |
      # Create a user in the $CRAFT_OVERLAY chroot
      groupadd -R $CRAFT_OVERLAY -g 1000 zookeeper
      useradd -R $CRAFT_OVERLAY -M -r -g zookeeper -u 1000 zookeeper
    override-prime: |
      craftctl default
      # Give permission to the required folder
      chown -R 1000:1000 opt/zookeeper
      chown -R 1000:1000 datalog
      chown -R 1000:1000 data
